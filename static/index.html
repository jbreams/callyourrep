<!DOCTYPE html>
<html>
<head>
<title>Place Autocomplete Address Form</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script src="https://maps.google.com/maps/api/js?libraries=places"></script>
<script src="https://code.angularjs.org/1.3.15/angular.js"></script>
<script src="https://rawgit.com/allenhwkim/angularjs-google-maps/master/build/scripts/ng-map.js"></script>
<script src="https:////static.twilio.com/libs/twiliojs/1.2/twilio.min.js"></script>
<script>
'use strict';

var module = angular.module('CallYourRep', ['ngMap']);
module.controller('CallYourRepCtrl', function($scope, $http, NgMap) {
    NgMap.getMap().then(function(map) {
        map.data.setStyle(function(feature) {
            var color;
            switch(feature.getProperty("party")) {
                case "Democrat":
                    color = "blue";
                    break;
                case "Republican":
                    color = "red";
                    break;
                default:
                    color = "black";
            }

            var ret = {
                strokeColor: color,
                strokeOpacity: 0.50,
                strokeWeight: 5,
                fillOpacity: 0,
                title: feature.getProperty('title'),
            }
            return ret;
        });
    });

    $scope.marker = null;
    $scope.districtInfo = [];

    $http.get('/api/twilioToken').then(function(resp) {
        Twilio.Device.setup(resp.data);
    },
    function(error) {
        console.log(error);
    });


    $scope.updateAddress = function() {
        $scope.resolvedPlace = this.getPlace().geometry.location;
        console.log('location', $scope.resolvedPlace);
        NgMap.getMap().then(function(map) {
            map.setCenter($scope.resolvedPlace);
            if ($scope.marker) {
				$scope.marker.setMap(null);
			}
			$scope.marker = new google.maps.Marker({
				position: $scope.resolvedPlace,
				map: map,
			});

            map.data.forEach(function(feature) {
                map.data.remove(feature);
            });

            var handleResp = function(response) {
                $scope.districtInfo = response.data;
                var bounds = new google.maps.LatLngBounds();
                response.data.forEach(function(district) {
                    var feature = map.data.addGeoJson({
                        type: "Feature",
                        geometry: district['district'],
                        properties: {
                            title: district['_id'],
                            party: district['party'],
                            type: district['type'],
                        },
                    });

                    feature[0].getGeometry().forEachLatLng(function(pt) {
                        bounds.extend(pt);
                    });
                });

                map.setCenter(bounds.center);
                map.fitBounds(bounds);
            }

            $http({
                method: 'GET',
                params: {
                    lat: $scope.resolvedPlace.lat(),
                    lon: $scope.resolvedPlace.lng(),
                },
                url: '/api/districts.json'}).then(
                handleResp,
                function (error) {
                    console.log(error);
                });
        });
    };

    $scope.callARep = function(district) {
        Twilio.Device.connect({ CallerId: "Outgoing", PhoneNumber: district['phone'] })
    }

    $scope.hangUp = function() {
        Twilio.Device.disconnectAll();
    }
});
</script>
</head>
<body ng-app="CallYourRep" ng-controller="CallYourRepCtrl">
<h1>Call your rep!</h1>
<p>Do you want to call your congress person, but don't know how? You've come to the right place!
To find your representatives, just put in your address below, and we'll call them for you!</p>
<input
    places-auto-complete
    size=80
    ng-model="address"
    component-restrictions="{country: 'us'}"
    types="['address']"
    on-place-changed="updateAddress();" />
<ng-map center="current-location">
</ng-map>

<div ng-repeat="district in districtInfo">
    <h3>{{district.repName}}</h3>
    <p>{{district._id}} {{district.party}}</p>
    <p>Phone number: {{district.phone}}
    <a href ng-click="callARep(district);">Call this Rep!!!</a>
</div>

</body>
</html>

