<!DOCTYPE html>
<html>
  <head>
	<title>Place Autocomplete Address Form</title>
	<meta name="viewport" content="initial-scale=1.0, width=device-width" />
	<!-- Angular Material style sheet -->
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">

	<!-- Angular Material requires Angular.js Libraries -->
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>

	<!-- Angular Material Library -->
	<script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>

	<script src="https://maps.google.com/maps/api/js?libraries=places"></script>
	<script src="https://rawgit.com/allenhwkim/angularjs-google-maps/master/build/scripts/ng-map.js"></script>
	<script src="https://static.twilio.com/libs/twiliojs/1.2/twilio.min.js"></script>
	<script>
'use strict';

var module = angular.module('CallYourRep', ['ngMap', 'ngMaterial']);
module.controller('CallYourRepCtrl', function($scope, $http, $mdDialog, NgMap, $interval) {
  NgMap.getMap().then(function(map) {
	map.data.setStyle(function(feature) {
	  var color;
	  switch(feature.getProperty("party")) {
		case "Democrat":
		  color = "blue";
		  break;
		case "Republican":
		  color = "red";
		  break;
		default:
		  color = "black";
	  }

	  var ret = {
		strokeColor: color,
		strokeOpacity: 0.50,
		strokeWeight: 5,
		fillOpacity: 0,
		title: feature.getProperty('title'),
	  }
	  return ret;
	});
  });

  $scope.marker = null;
  $scope.districtInfo = [];

  $http.get('/api/twilioToken').then(function(resp) {
	Twilio.Device.setup(resp.data);
  },
  function(error) {
	console.log(error);
  });


  $scope.updateAddress = function() {
	$scope.resolvedPlace = this.getPlace().geometry.location;
	console.log('location', $scope.resolvedPlace);
	NgMap.getMap().then(function(map) {
	  if ($scope.marker) {
		$scope.marker.setMap(null);
	  }
	  $scope.marker = new google.maps.Marker({
		position: $scope.resolvedPlace,
		map: map,
	  });

	  map.data.forEach(function(feature) {
		map.data.remove(feature);
	  });

	  var handleResp = function(response) {
		$scope.districtInfo = response.data;
		var bounds = new google.maps.LatLngBounds();
		response.data.forEach(function(district) {
		  var feature = map.data.addGeoJson({
			type: "Feature",
			geometry: district['district'],
			properties: {
			  title: district['_id'],
			  party: district['party'],
			  type: district['type'],
			},
		  });

		  feature[0].getGeometry().forEachLatLng(function(pt) {
			bounds.extend(pt);
		  });
		});

		document.getElementById("districtMapAndList").classList.remove("ng-hide");
		google.maps.event.trigger(map,'resize')
		map.setCenter(bounds.center);
		map.fitBounds(bounds);
	  }

	  $http({
		method: 'GET',
		params: {
		  lat: $scope.resolvedPlace.lat(),
		  lon: $scope.resolvedPlace.lng(),
		},
		url: '/api/districts.json'}).then(
			   handleResp,
			   function (error) {
				 console.log(error);
			   });
	});
  };

  $scope.showCallerDlg = function(ev, district) {
		$mdDialog.show({
			controller: function($scope, $mdDialog) {
				$scope.callButtonText="Call them!";

        $http({
          method: 'GET',
          params: { district: district._id },
          url: '/api/topics.json'}).
        then(function(resp) {
          $scope.topics = resp.data;
          console.log($scope.topics);
        },
        function(error) {
          console.log(error);
        });

				$scope.district = district;
				$scope.timer = {
					count: 600,
					mins: 10,
					secs: 0
				};

				$scope.inCall = false;
				$scope.toggleCall = function() {
					if ($scope.callButtonText == "Call them!") {
						$scope.callButtonText = "Hang up!";
						$scope.countdownTimer = $interval(function() {
							if ($scope.timer.count == 0)
								return;
							$scope.timer.count -= 1;
							$scope.timer.mins = Math.floor($scope.timer.count / 60);
							$scope.timer.secs = $scope.timer.count % 60;
						}, 1000);

						Twilio.Device.connect({CallerID: "Outgoing", PhoneNumber: district['phone']});

						Twilio.Device.disconnect($scope.toggleCall);
					} else {
						$mdDialog.hide();
						if ($scope.countdownTimer) {
							$interval.cancel($scope.countdownTimer);
						}
					}
				}
			},
		  onRemoving: function(element, removePromise) {
				Twilio.Device.disconnectAll();
			},
			templateUrl: '/static/caller.html',
			parent: angular.element(document.body),
			targetEvent: ev,
			clickOutsideToClose: false,
			fullscreen: false,
		});
	};

  $scope.callARep = function(district) {
	Twilio.Device.connect({ CallerId: "Outgoing", PhoneNumber: district['phone'] })
  }

  $scope.hangUp = function() {
	Twilio.Device.disconnectAll();
  }
});
	</script>
  </head>
  <body ng-app="CallYourRep" ng-controller="CallYourRepCtrl" class="md-padding" ng-cloak>
	<div layout="column" class="zero">
	  <h1>Call your rep!</h1>
	  <p>Do you want to call your congress person, but don't know how? You've come to the right place!
	  To find your representatives, just put in your address below, and we'll call them for you!</p>
	  <input
		places-auto-complete
		size=80
		ng-model="address"
		component-restrictions="{country: 'us'}"
		types="['address']"
		on-place-changed="updateAddress();" />
	  <div id="districtMapAndList" class="ng-hide">
  		<ng-map></ng-map>
      <div ng-repeat="district in districtInfo">
        <md-card>
        <md-card-title>
          <md-card-title-text>
          <span class="md-headline">{{district.repName}}</span>
          </md-card-title-text>
          <md-card-title-media>
          <img class="md-media-sm card-media"
             src="https://theunitedstates.io/images/congress/225x275/{{district.pictureId}}.jpg">
          </md-card-title-media>

        </md-card-title>
        <md-card-content>
          <p>{{district._id}} {{district.type}} ({{district.party}})</p>
          <p>Phone number: {{district.phone}}</p>
        </md-card-content>
        <md-card-actions layout="row" layout-align="end center">
          <md-button ng-click="showCallerDlg($event, district);">Call this Rep!</md-button>
        </md-card-actions>
        </md-card>
      </div>
	  </div>
	</div>
  </body>
</html>

