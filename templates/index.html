<!DOCTYPE html>
<html>
  <head>
	<title>Call Your Rep!</title>
	<meta name="viewport" content="initial-scale=1.0, width=device-width" />
	<!-- Angular Material style sheet -->
  <link rel="shortcut icon" type="image/png" href="/static/favicon.png"/>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">
  <link rel="stylesheet" href="/static/main.css">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<!-- Angular Material requires Angular.js Libraries -->
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>

	<!-- Angular Material Library -->
	<script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>

  <script src="https://maps.google.com/maps/api/js?libraries=places&key=%% googleAPIKey %%"></script>
	<script src="https://cdn.rawgit.com/allenhwkim/angularjs-google-maps/master/build/scripts/ng-map.js"></script>
	<script src="https://static.twilio.com/libs/twiliojs/1.2/twilio.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/sha1.js"></script>

  </head>
  <body layout="column" ng-app="CallYourRep"
    ng-controller="CallYourRepCtrl" ng-cloak>
		<div class="content-wrapper" layout="column" layout-xs="column" layout-margins>
    <img src="/static/header.svg" style="width: 100%; height: auto;">
	  <h1>Call Your Rep!</h1>
	  <p>Do you want to call your congress person, but don't know how? You've come to the right place!
	  To find your representatives, just put in your address below, and we'll call them for you!</p>
		<span layout="row">
	  <input
		places-auto-complete
		ng-model="address"
		component-restrictions="{country: 'us'}"
		types="['address']"
		on-place-changed="updateAddress();"
		flex
		/>
		<md-button class="md-raised" ng-click="updateAddress();">Lookup your reps!</md-button>
	  </span>
	  <div id="districtMapAndList" class="ng-hide">
  		<ng-map></ng-map>
      <md-list>
        <md-list-item class="md-3-line md-long-text" ng-repeat="district in districtInfo">
          <img class="md-avatar"
              ng-src="https://theunitedstates.io/images/congress/225x275/{{district.pictureId}}.jpg">
          <div class="md-list-item-text" layout="column">
            <span layout="row">
              <span layout="column">
                <span class="md-headline">{{district.repName}}</span>
                <span class="md-subhead">{{district.fullTitle}}</span>
              </span>
              <span flex></span>
              <span>
               <md-button layout-align="start end" class="md-primary md-raised"
                 ng-click="showTopicsDlg($event, district, addressHash);">
                Call this Rep!
               </md-button>
              </span>
            </span>
            <md-tabs md-dynamic-height>
              <md-tab label="Bio">
                <md-content class="md-padding">
                  <b>{{district.repName}}</b> {{district.bio}}
                </md-content>
              </md-tab>
              <md-tab label="Committee Membership">
                <md-content class="md-padding">
                  <ul>
                    <li ng-repeat="committee in district.committees">
                      <p><a href="{{committee.url}}">{{committee.name}}</a></p>
                      <p ng-if="committee.jurisdiction">Jurisdiction: {{committee.jurisdiction}}</p>
                      <p ng-if="committee.phone">Phone: {{committee.phone}}</p>
                    </li>
                  </ul>
                </md-content>
              </md-tab>
              <md-tab label="Contact Info">
                <md-content class="md-padding">
                  <p><strong>Phone number:</strong> <a href='tel:{{district.phone}}'>
                    {{district.phone}}
                  </a></p>
                  <p ng-if="district.contactForm">
                    <strong>Online contact form:</strong> 
                      <a href='{{district.contactForm}}' target="_blank">
                      {{district.contactForm}}
                  </a></p>
                  <p ng-if="district.fax">
                    <strong>Fax number (because, why not?):</strong> {{district.fax}}
                  </p>
                  <p ng-if="district.mailingAddress">
                    <strong>Mailing address:</strong> {{district.mailingAddress}}
                  </p>
                </md-content>
              </md-tab>
            </md-tabs>
          </div>
        </md-list-item>
      </md-list>
    </div>
    <p align=center>Questions? Comments? Contact us at 
      <a href='mailto:contact@callyourrep.us'>contact@callyourrep.us</a>
    </p>
</div>

  </body>
	<script>
'use strict';

var module = angular.module('CallYourRep', ['ngMap', 'ngMaterial']);

module.controller('CallYourRepCtrl',
    function($scope, $http, $mdDialog, NgMap, $interval, $anchorScroll, $location) {
  NgMap.getMap().then(function(map) {
	map.data.setStyle(function(feature) {
	  var color;
	  switch(feature.getProperty("party")) {
		case "Democrat":
		  color = "blue";
		  break;
		case "Republican":
		  color = "red";
		  break;
		default:
		  color = "black";
	  }

	  var ret = {
		strokeColor: color,
		strokeOpacity: 0.50,
		strokeWeight: 5,
		fillOpacity: 0,
		title: feature.getProperty('title'),
	  }
	  return ret;
	});
  });

  $scope.marker = null;
  $scope.districtInfo = [];

  $http.get('/api/twilioToken').then(function(resp) {
	Twilio.Device.setup(resp.data);
  },
  function(error) {
	console.log(error);
  });

  $scope.updateAddress = function() {
    $scope.resolvedPlace = this.getPlace().geometry.location;
		$scope.addressHash = CryptoJS.SHA1(this.getPlace().formattedAddress)

    NgMap.getMap().then(function(map) {
      if ($scope.marker) {
        $scope.marker.setMap(null);
      }
      $scope.marker = new google.maps.Marker({
        position: $scope.resolvedPlace,
        map: map,
      });

      map.data.forEach(function(feature) {
        map.data.remove(feature);
      });

      var handleResp = function(response) {
        $scope.districtInfo = response.data;
        var bounds = new google.maps.LatLngBounds();
        response.data.forEach(function(district) {
          var feature = map.data.addGeoJson({
          type: "Feature",
          geometry: district['district'],
          properties: {
            title: district['_id'],
            party: district['party'],
            type: district['type'],
          },
          })
          feature[0].getGeometry().forEachLatLng(function(pt) {
          bounds.extend(pt);
          });
        });

        document.getElementById("districtMapAndList").classList.remove("ng-hide");
        google.maps.event.trigger(map,'resize')
        map.setCenter(bounds.center);
        map.fitBounds(bounds);
        $location.hash('districtMapAndList');
      }

      $http({
      method: 'GET',
      params: {
        lat: $scope.resolvedPlace.lat(),
        lon: $scope.resolvedPlace.lng(),
      },
      url: '/api/districts.json'}).then(
           handleResp,
           function (error) {
           console.log(error);
           });
    });
  };

  $scope.showCallerDlg = function showCallerDlg(ev, district, loc, topic) {
		$mdDialog.show({
			controller: function($scope, $mdDialog) {
				$scope.callButtonText="Call them!";
        $scope.callscript = topic;

				$scope.district = district;
				$scope.timer = {
					count: 600,
					mins: 10,
					secs: 0
				};

        $scope.supportsCalls = true;
        Twilio.Device.error(function(error) {
          if (error.code == 31208) {
            $scope.supportsCalls = false;
          } else {
            alert(error.message);
          }
        });

				$scope.inCall = false;
				$scope.toggleCall = function() {
					if ($scope.callButtonText == "Call them!") {
						$scope.callButtonText = "Hang up!";
						$scope.countdownTimer = $interval(function() {
							if ($scope.timer.count == 0)
								return;
							$scope.timer.count -= 1;
							$scope.timer.mins = Math.floor($scope.timer.count / 60);
							$scope.timer.secs = $scope.timer.count % 60;
						}, 1000);

						Twilio.Device.connect({PhoneNumber: district['phone'], AddressHash: loc});
						Twilio.Device.disconnect($scope.toggleCall);
					} else {
						$mdDialog.hide();
						if ($scope.countdownTimer) {
							$interval.cancel($scope.countdownTimer);
						}
					}
				}

        $scope.nevermind = function() {
          $mdDialog.hide();
          if ($scope.countdownTimer) {
            $interval.cancel($scope.countdownTimer);
          }
        }
			},
		  onRemoving: function(element, removePromise) {
				Twilio.Device.disconnectAll();
			},
			templateUrl: '/static/caller.html',
			parent: angular.element(document.body),
			targetEvent: ev,
			clickOutsideToClose: false,
			fullscreen: false,
		});
	};

  $scope.showTopicsDlg = function(ev, district, loc) {
    var showCallerDlg = $scope.showCallerDlg;
    $mdDialog.show({
      controller: function($scope, $mdDialog) {
        $scope.searchTerms = "";
        $scope.topics = [];
        $scope.getTopicId = function(o) {
          return o._id.$oid;
        }

        $http({
          method: 'GET',
          url: '/api/topics.json'}).
        then(function(resp) {
          $scope.topics = resp.data;
        },
        function(error) {
          console.log(error)
        });

        $scope.updateList = function() {
          $http({
            method: 'GET',
            params: { search: $scope.searchTerms },
            url: '/api/topics.json'}).
          then(function(resp) {
            $scope.topics = resp.data;
          },
          function(error) {
            console.log(error);
          });
        };

        $scope.showDialer = function(script) {
          $scope.topics = [];
          $scope.searchTerms = "";
          $mdDialog.hide();
          showCallerDlg(ev, district, loc, script);
        }

				$scope.nevermind = function() {
					$mdDialog.hide();
					$scope.topics = [];
					$scope.searchTerms = "";
				}
      },
      templateUrl: '/static/topics.html',
      parent: angular.element(document.body),
      targetEvent: ev,
      clickOutsideToClose: true,
      fullscreen: false,
    });
  }
});

$(document).on({
            'DOMNodeInserted': function () {
                $('.pac-item, .pac-item span', this).addClass('needsclick');
            }
        }, '.pac-container');
	</script>
</html>

